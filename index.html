<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini å°è©±æ•´ç†å™¨ (å°ˆæ¥­ç‰ˆ v3.2)</title>
  <style>
    /* åŸºç¤æ¨£å¼ */
    body { 
      font-family: 'Noto Sans TC', 'Segoe UI', sans-serif; 
      background: #f5f5fb; 
      padding: 20px; 
      margin: 0;
    }
    .container { 
      max-width: 700px; 
      margin: auto; 
      background: #fff; 
      border-radius: 14px; 
      box-shadow: 0 8px 32px #dfdffc55; 
      padding: 24px 30px;
    }
    h2 { 
      color: #6c60e0; 
      margin-top: 0;
      margin-bottom: 18px; 
      text-align: center;
    }

    /* ä¸Šå‚³å€ */
    .upload-area {
      border: 2px dashed #c0c2d9;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin-bottom: 24px;
      background-color: #f7f7fd;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .upload-area:hover {
      background-color: #e8e6ff;
      border-color: #7966f2;
    }
    #fileInput {
      display: none;
    }
    #uploadLabel {
      font-weight: 500;
      color: #5949c7;
    }
    #fileName {
      display: block;
      margin-top: 8px;
      font-size: 0.9em;
      color: #666;
    }

    /* ç¯©é¸èˆ‡è¨­å®šå€ */
    .controls-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 20px;
    }
    .controls-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .control-group label {
        display: block;
        font-weight: 500;
        color: #555;
        margin-bottom: 6px;
    }
    .control-group select, .control-group input[type="text"], .control-group input[type="number"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #c0c2d9;
        border-radius: 6px;
        background-color: #fdfdff;
        box-sizing: border-box;
    }
    #page-range-info {
        font-size: 0.85em;
        color: #7966f2;
        text-align: center;
        margin-top: 4px;
        min-height: 1.2em;
    }

    /* æ–‡å­—å€å¡Š */
    textarea { 
      width: 100%; 
      box-sizing: border-box; 
      border: 1px solid #c0c2d9; 
      border-radius: 6px; 
      padding: 14px; 
      background: #f7f7fd; 
      margin-bottom: 14px; 
      font-family: inherit; 
      font-size: 1em; 
      resize: vertical; 
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    textarea:focus, .control-group input:focus, .control-group select:focus {
      border-color: #7966f2;
      box-shadow: 0 0 0 3px rgba(121, 102, 242, 0.2);
      outline: none;
    }
    #output { 
      min-height: 250px; 
      white-space: pre-wrap; 
    }
    #formatTemplate { 
      min-height: 120px; 
      font-family: 'Courier New', Courier, monospace; 
      color: #333;
      background-color: #fdfdff;
    }

    /* æŒ‰éˆ•å€ */
    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 16px;
    }
    .btn { 
      padding: 10px 20px; 
      border: none; 
      background: #7966f2; 
      color: #fff; 
      border-radius: 8px; 
      font-size: 1em; 
      font-weight: 500;
      cursor: pointer; 
      transition: background-color .2s, transform .1s;
      flex-grow: 1;
    }
    .btn:hover { 
      background: #5949c7;
    }
    .btn:active {
        transform: scale(0.98);
    }
    .btn.clear { 
      background: #e06060; 
    }
    .btn.clear:hover { 
      background: #c74949; 
    }

    /* èªªæ˜èˆ‡å€å¡Š */
    .info { 
      color: #667; 
      font-size: 0.95em; 
      margin-bottom: 10px;
      padding: 12px;
      background-color: #f7f7fd;
      border-radius: 8px;
      line-height: 1.6;
    }
    .info code {
      background-color: #e8e6ff;
      padding: 2px 6px;
      border-radius: 4px;
      color: #5949c7;
      font-weight: bold;
      font-size: 0.95em;
    }
    .footer { 
      margin-top: 18px; 
      text-align: center; 
      color: #aaa; 
      font-size: 0.9em;
    }
    .section-title { 
      font-size: 1.2em; 
      color: #555; 
      margin-top: 20px;
      margin-bottom: 8px; 
      border-left: 4px solid #7966f2;
      padding-left: 8px;
    }
    #status-bar {
        text-align: right;
        font-size: 0.9em;
        color: #667;
        margin-bottom: 10px;
        min-height: 1.2em;
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 600px) {
      body { padding: 10px; }
      .container { padding: 18px 20px; }
      .button-group { flex-direction: column; }
      .controls-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Gemini å°è©±æ•´ç†å™¨ (å°ˆæ¥­ç‰ˆ v3.2)</h2>
    
    <label for="fileInput" class="upload-area">
      <span id="uploadLabel">é»æ“Šæ­¤è™•æˆ–æ‹–æ›³æª”æ¡ˆä¸Šå‚³</span>
      <span id="fileName">å°šæœªé¸æ“‡æª”æ¡ˆ</span>
    </label>
    <input type="file" id="fileInput" accept=".html">

    <div class="controls-container">
        <div class="control-group">
            <label for="gemFilter">1. ç¯©é¸ Gem è§’è‰²:</label>
            <select id="gemFilter" disabled>
                <option value="all">è«‹å…ˆä¸Šå‚³æª”æ¡ˆ</option>
            </select>
        </div>
        <div class="control-group">
            <label for="pageStart">2. ç¯©é¸é ç¢¼ç¯„åœ:</label>
            <div class="controls-grid">
                <input type="number" id="pageStart" placeholder="èµ·å§‹é ç¢¼" disabled>
                <input type="number" id="pageEnd" placeholder="çµæŸé ç¢¼" disabled>
            </div>
            <div id="page-range-info"></div>
        </div>
        <div class="control-group">
            <label for="searchFilter">3. é—œéµå­—æœå°‹:</label>
            <input type="text" id="searchFilter" placeholder="åœ¨æå•èˆ‡å›è¦†ä¸­æœå°‹..." disabled>
        </div>
    </div>
    
    <h3 class="section-title">è‡ªè¨‚è¼¸å‡ºæ ¼å¼</h3>
    <div class="info">
      <b>åƒæ•¸å®šç¾©èªªæ˜ï¼š</b><br>
      <code>[TIME]</code>: å¯¦éš›èŠå¤©æ™‚é–“<br>
      <code>[PROMPT]</code>: æˆ‘çš„å›è¦†<br>
      <code>[RESPONSE]</code>: è§’è‰²å›è¦†<br>
      <code>[GEM_NAME]</code>: è§’è‰²åç¨±
    </div>
    <textarea id="formatTemplate">ï¼»[TIME]ï¼½
æˆ‘: [PROMPT]
Gemini ([GEM_NAME]):
[RESPONSE]
---
</textarea>
    </div>

    <div class="button-group">
        <button class="btn" onclick="copyOutput()">è¤‡è£½çµæœ</button>
        <button class="btn" onclick="downloadTxt()">ä¸‹è¼‰ TXT</button>
        <button class="btn clear" onclick="clearAll()">æ¸…é™¤é‡ç½®</button>
    </div>

    <div id="status-bar"></div>
    <textarea id="output" readonly placeholder="è§£æçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡â€¦"></textarea>

    <div class="footer">
      ç”±@minijinai75å’Œå¥¹çš„å°ç²¾éˆå€‘ä¸€èµ·å„ªåŒ–èˆ‡å»ºæ§‹ ğŸ’œï½œæª”æ¡ˆå…¨ç¨‹åœ¨æ‚¨çš„è£ç½®é›¢ç·šè™•ç†ï¼Œå®‰å…¨ç„¡è™ã€‚
    </div>
  </div>

  <script>
    let allEntries = []; // å„²å­˜æ‰€æœ‰è§£æå‡ºçš„å°è©±è¨˜éŒ„

    // DOM å…ƒç´ ç²å–
    const fileInput = document.getElementById('fileInput');
    const fileNameSpan = document.getElementById('fileName');
    const outputEl = document.getElementById('output');
    const gemFilter = document.getElementById('gemFilter');
    const searchFilter = document.getElementById('searchFilter');
    const pageStartInput = document.getElementById('pageStart');
    const pageEndInput = document.getElementById('pageEnd');
    const pageRangeInfo = document.getElementById('page-range-info');
    const formatTemplateTextarea = document.getElementById('formatTemplate');
    const uploadArea = document.querySelector('.upload-area');
    const statusBar = document.getElementById('status-bar');

    // --- äº‹ä»¶ç›£è½ ---
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        fileNameSpan.textContent = `å·²é¸æ“‡: ${file.name}`;
        handleFile(file);
      }
    });

    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.backgroundColor = '#e8e6ff'; uploadArea.style.borderColor = '#7966f2'; });
    uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.style.backgroundColor = '#f7f7fd'; uploadArea.style.borderColor = '#c0c2d9'; });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = '#f7f7fd';
        uploadArea.style.borderColor = '#c0c2d9';
        const file = e.dataTransfer.files[0];
        if (file && file.type === 'text/html') {
            fileInput.files = e.dataTransfer.files;
            fileNameSpan.textContent = `å·²é¸æ“‡: ${file.name}`;
            handleFile(file);
        } else {
            alert('è«‹æ‹–æ›³æœ‰æ•ˆçš„ HTML æª”æ¡ˆï¼');
        }
    });

    gemFilter.addEventListener('change', renderOutput);
    searchFilter.addEventListener('input', renderOutput);
    pageStartInput.addEventListener('input', renderOutput);
    pageEndInput.addEventListener('input', renderOutput);
    formatTemplateTextarea.addEventListener('input', renderOutput);


    // --- æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

    function handleFile(file) {
      outputEl.value = 'æª”æ¡ˆè®€å–ä¸­ï¼Œæ­£åœ¨ç‚ºæ‚¨è§£æâ€¦';
      outputEl.readOnly = true;
      statusBar.textContent = '';
      
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const html = evt.target.result;
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          const conversationBlocks = doc.querySelectorAll('.outer-cell.mdl-cell--12-col');
          if (conversationBlocks.length === 0) {
            throw new Error('åœ¨æª”æ¡ˆä¸­æ‰¾ä¸åˆ°ä»»ä½•å°è©±å€å¡Š (.outer-cell)ã€‚è«‹ç¢ºèªæª”æ¡ˆä¾†æºæ˜¯å¦æ­£ç¢ºã€‚');
          }
          
          const parsedEntries = [];
          conversationBlocks.forEach(block => {
            const contentCell = block.querySelector('.content-cell.mdl-cell--6-col');
            if (!contentCell) return;
            
            let time = '', gemName = 'N/A', prompt = '[æ‰¾ä¸åˆ°æå•]', response = '', pageNumber = null;

            const childNodes = Array.from(contentCell.childNodes);
            let timeNodeFound = false;

            for (const node of childNodes) {
                if (node.nodeType === 3) { // æ–‡å­—ç¯€é»
                    const text = node.textContent.trim();
                    if (text.startsWith('Prompted')) {
                        prompt = text.replace(/^Prompted\s*/, '').trim();
                    } else if (text.includes('was used in this chat')) {
                        const gemMatch = text.match(/^(.*?) was used in this chat/);
                        if (gemMatch) gemName = gemMatch[1].trim();
                    } else if (/\d{4}å¹´.*?CST/.test(text)) {
                        const timeMatch = text.match(/(\d{4}å¹´.*?CST)/);
                        if (timeMatch) {
                            time = timeMatch[0];
                            timeNodeFound = true;
                        }
                    }
                } else if (node.nodeType === 1 && node.tagName === 'P' && timeNodeFound) { // å…ƒç´ ç¯€é»
                    const pageMatch = node.innerText.match(/page\.(\d+)/);
                    if (pageMatch) {
                        pageNumber = parseInt(pageMatch[1], 10);
                    }
                    const pText = node.innerText; // ä¿ç•™åŸå§‹æ–‡å­—ï¼ŒåŒ…å«é ç¢¼
                    if (pText) response += pText + '\n\n';
                }
            }
            
            if (!time) return;

            parsedEntries.push({ time, gemName, prompt, response: response.trim(), pageNumber });
          });

          if (parsedEntries.length === 0) {
            throw new Error('æˆåŠŸè§£ææª”æ¡ˆï¼Œä½†æœªæ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„ Gemini å°è©±å…§å®¹ã€‚');
          }
          
          allEntries = parsedEntries.reverse();
          
          populateGemFilter(allEntries);
          searchFilter.disabled = false;
          pageStartInput.disabled = false;
          pageEndInput.disabled = false;
          renderOutput();

        } catch (error) {
          outputEl.value = `âŒ è§£æå¤±æ•—ï¼š${error.message}\nè«‹ç¢ºèªæ‚¨ä¸Šå‚³çš„æ˜¯å¾ Google Takeout åŒ¯å‡ºçš„ Gemini æ´»å‹•ç´€éŒ„ HTML åŸæª”ã€‚`;
          allEntries = [];
        } finally {
            outputEl.readOnly = false;
        }
      };
      reader.onerror = function() {
          outputEl.value = 'âŒ è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼';
          allEntries = [];
          outputEl.readOnly = false;
      };
      reader.readAsText(file, 'utf-8');
    }

    function populateGemFilter(entries) {
        const uniqueGems = [...new Set(entries.map(e => e.gemName))];
        gemFilter.innerHTML = '';
        
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = `é¡¯ç¤ºå…¨éƒ¨ (${entries.length}å‰‡)`;
        gemFilter.appendChild(allOption);

        uniqueGems.forEach(gem => {
            if (gem === 'N/A') return;
            const count = entries.filter(e => e.gemName === gem).length;
            const option = document.createElement('option');
            option.value = gem;
            option.textContent = `${gem} (${count}å‰‡)`;
            gemFilter.appendChild(option);
        });
        gemFilter.disabled = false;
    }

    function renderOutput() {
        if (allEntries.length === 0) return;

        const selectedGem = gemFilter.value;
        const searchTerm = searchFilter.value.toLowerCase();
        const template = formatTemplateTextarea.value;
        const startPage = parseInt(pageStartInput.value) || 0;
        const endPage = parseInt(pageEndInput.value) || Infinity;

        let filteredEntries = allEntries;

        // 1. æ ¹æ“š Gem åç¨±ç¯©é¸
        if (selectedGem !== 'all') {
            filteredEntries = filteredEntries.filter(entry => entry.gemName === selectedGem);
        }
        
        // æ›´æ–°é ç¢¼æç¤º
        const pageNumbers = filteredEntries.map(e => e.pageNumber).filter(n => n !== null);
        if (pageNumbers.length > 0) {
            const minPage = Math.min(...pageNumbers);
            const maxPage = Math.max(...pageNumbers);
            pageRangeInfo.textContent = `å¯ç”¨é ç¢¼ç¯„åœ: ${minPage} - ${maxPage}`;
        } else {
            pageRangeInfo.textContent = 'æ­¤ç¯©é¸çµæœç„¡é ç¢¼è³‡è¨Š';
        }

        // 2. æ ¹æ“šé ç¢¼ç¯„åœç¯©é¸
        filteredEntries = filteredEntries.filter(entry => {
            if (entry.pageNumber === null) return true;
            return entry.pageNumber >= startPage && entry.pageNumber <= endPage;
        });

        // 3. æ ¹æ“šé—œéµå­—ç¯©é¸
        if (searchTerm) {
            filteredEntries = filteredEntries.filter(entry => 
                entry.prompt.toLowerCase().includes(searchTerm) || 
                entry.response.toLowerCase().includes(searchTerm)
            );
        }

        const formattedText = filteredEntries.map(ent => {
            return template
              .replace(/\[TIME\]/g, ent.time)
              .replace(/\[PROMPT\]/g, ent.prompt)
              .replace(/\[RESPONSE\]/g, ent.response)
              .replace(/\[GEM_NAME\]/g, ent.gemName);
        }).join('');

        outputEl.value = formattedText;
        statusBar.textContent = `æ­£åœ¨é¡¯ç¤º ${filteredEntries.length} / ${allEntries.length} å‰‡å°è©±`;
    }

    // --- å·¥å…·æŒ‰éˆ•å‡½å¼ ---

    function copyOutput() {
      const text = outputEl.value;
      if (!text || text.startsWith('âŒ') || text.startsWith('è§£æçµæœ')) return;
      
      try {
        navigator.clipboard.writeText(text).then(() => {
            alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }, () => {
            fallbackCopyTextToClipboard(text);
        });
      } catch (err) {
        fallbackCopyTextToClipboard(text);
      }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            else alert('è¤‡è£½å¤±æ•—ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚');
        } catch (err) {
            alert('è¤‡è£½æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼');
        }
        document.body.removeChild(textArea);
    }

    function downloadTxt() {
      const textToSave = outputEl.value;
      if (!textToSave || textToSave.startsWith('âŒ') || textToSave.startsWith('è§£æçµæœ')) return;

      const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      const selectedGem = gemFilter.value === 'all' ? 'å…¨éƒ¨' : gemFilter.value;
      const searchTerm = searchFilter.value;
      const startPage = pageStartInput.value;
      const endPage = pageEndInput.value;

      let pagePart = '_æ•´ç†';
      if (startPage && endPage) {
          pagePart = `_æ•´ç†PAGE${startPage}-${endPage}`;
      } else if (startPage) {
          pagePart = `_æ•´ç†PAGE${startPage}-`;
      } else if (endPage) {
          pagePart = `_æ•´ç†PAGE-${endPage}`;
      }
      
      const searchPart = searchTerm ? `_é—œæ–¼${searchTerm}` : '';
      a.download = `Gemini_${selectedGem}${pagePart}${searchPart}.txt`;

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function clearAll() {
      fileInput.value = '';
      outputEl.value = '';
      outputEl.placeholder = 'è§£æçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡â€¦';
      fileNameSpan.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
      statusBar.textContent = '';
      
      gemFilter.innerHTML = '<option value="all">è«‹å…ˆä¸Šå‚³æª”æ¡ˆ</option>';
      gemFilter.disabled = true;
      
      searchFilter.value = '';
      searchFilter.disabled = true;

      pageStartInput.value = '';
      pageStartInput.disabled = true;
      pageEndInput.value = '';
      pageEndInput.disabled = true;
      pageRangeInfo.textContent = '';

      allEntries = [];
    }
  </script>
</body>
</html>
